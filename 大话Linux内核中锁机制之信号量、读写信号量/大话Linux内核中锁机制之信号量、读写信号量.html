<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.3 (452832)"/><meta name="altitude" content="8.706424713134766"/><meta name="author" content="肖刘福"/><meta name="created" content="2016-01-13 02:35:47 +0000"/><meta name="latitude" content="39.92345275344086"/><meta name="longitude" content="119.5430519493569"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-01-13 02:35:57 +0000"/><title>大话Linux内核中锁机制之信号量、读写信号量</title></head><body>
<div><span style="color: rgb(70, 70, 70);"><span style="font-family: simsun;"><span style="font-size: 28px;"><b><br/></b></span></span></span></div>
<div>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">在上一篇博文中笔者分析了关于内存屏障、读写自旋锁以及顺序锁的相关内容，本篇博文将着重讨论有关信号量、读写信号量的内容。</span></p>
<h2 style="padding: 0px; border: 0px; list-style: none; color: rgb(70, 70, 70); font-family: simsun; font-style: normal; font-variant: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: -1cm;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;"><span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';"> </span></span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">六、信号量</span></h2>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">关于信号量的内容，实际上它是与自旋锁类似的概念，只有得到信号量的进程才能执行临界区的代码；不同的是获取不到信号量时，进程不会原地打转而是进入休眠等待状态。它的定义是</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">include\linux\semaphore.h</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">文件中，结构体如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">6.1</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">所示。其中的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">变量是计数作用，通过使用</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">lock</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">变量实现对</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">变量的保护，而</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 'Times new roman', serif;">wait_list</span><span style="word-wrap: normal; word-break: normal; text-indent: 24pt; font-size: 12pt; font-family: 宋体;">则是对申请信号量的进程维护的等待队列。</span><font face="'Times New Roman', serif" size="3" style="word-wrap: normal; word-break: normal; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal;"> </span></font></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/8B60201B-1BDB-4862-937D-31B3F90231F1.jpg" height="171" width="313"/></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图6.1 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">信号量的结构体定义</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">我们首先看下它是如何使用的，首先定义一个信号量，然后初始化信号量，它包括两种方法。如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.2</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示。方法</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">1</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">：简单的初始化，定义信号量的个数由</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">val</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">决定，实际上</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">val</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">值即是赋给信号量结构体中的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">变量；方法</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">2</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">是直接将结构体中</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">值设置成</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">1</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，此时信号量可用于实现进程间的互斥量。注意：对于信号量的初始化函数</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">Linux</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">最新版本存在变化，本文所采用的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">Linux</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">版本已不存在如</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">init_MUTEX</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">和</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">init_MUTEX_LOCKED</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">等初始化函数，同时也更换了名字等，这点读者在阅读的时候需要下，因此笔者建议以后在编程中遇到需要使用信号量的时候尽量采用</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">sema_init(struct semaphore *sem, int val)</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数，因为这个函数就目前为止从未发生变化。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s15.sinaimg.cn/orignal/6d7fa49bgbe2f5de3a35e" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/BA6EE554-37BB-4B6B-8205-AB389A6DFB7E.jpg" height="285" width="490"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;"><span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';"> </span>图6.2 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">信号量的初始函数</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">下面我们讨论如何获得信号量，它主要包括三个函数，第一个函数表示当信号申请不到时会进程会休眠；对于第二个函数来说，它表示如果当进程因申请不到信号量而进入睡眠后，能被信号打断，这里所说的信号是指进程间通信的信号，比如我们的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">Ctrl+C</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，但这时候这个函数的返回值不为</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">0</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">；第三个函数表示信号量无论是否获得，都将立即返回，但返回值会根据是否申请成功而定，同时这个函数也不会导致睡眠。最后的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">up</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数，这个还是很好理解的，就是释放信号量，进而唤醒队列中的等待信号量的进程。函数如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.3</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所展示一般。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s8.sinaimg.cn/orignal/6d7fa49bgbe2f5ec647c7" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/F9ECC964-D87E-4D44-809F-E7C6CBAA21D4.jpg" height="261" width="490"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;"><span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';"> </span>图6.3 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">信号量的获得和释放函数</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">接下来笔者将举几个例子，依次如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.4</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.5</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示。图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.4</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">的例子仍是实现一个设备只能被一个进程打开。例子很简单，这里便不再细说，主要体现到底如何使用信号量。如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.4</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所展示。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s6.sinaimg.cn/orignal/6d7fa49bgbe2f5f8a6735" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/482C1E2C-A418-493A-9C92-56517B5D501F.jpg" height="325" width="490"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图6.4 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">信号量的使用示例</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.5</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">实现的是进程间的同步问题。实际上，当把信号量的初始值为</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">0</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，则可以实现同步了。正如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.5</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所展示一般，对于执行单元</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">A</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">而言，如果执行单元</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">B</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">不执行</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">up</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数，执行单元</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">A</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">就因为申请不到进程而睡眠，直至</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">up</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数被调用，所以执行代码</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">b</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">前必须等到执行单元</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">B</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">执行完代码</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">c</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">。相信这个内容在操作系统课程都均有提及。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s9.sinaimg.cn/orignal/6d7fa49bgf6dd9c7b12a8" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/61AC3578-4F81-4CE3-86A7-8FCF97B692D4.jpg" height="226" width="501"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图6.5 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">信号量实现同步示例</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">讨论过示例后，相信读者对于信号量的使用有了比较好的了解。下面让我们来简单的讨论下它的实现机制。通过了解信号量的结构体，可以发现结构体中除了使用自旋锁机制外，就是</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">值的变化（这一点先前已提及）。它的源码如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.6</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">6.7</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示。</span><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s8.sinaimg.cn/orignal/6d7fa49bgbe2f622eccd7" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/6E9EFB18-15AB-4DCC-9AE9-339FCE851BA5.jpg" height="240" width="690"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">6.6 </span> <span style="word-wrap: normal; word-break: normal; font-family: 宋体;">信号量</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">down</span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">函数内核源码</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">                                          </span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">6.7 </span> <span style="word-wrap: normal; word-break: normal; font-family: 宋体;">信号量</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">up</span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">函数内核源码</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">从源码中可以看到信号量利用自旋锁的相关函数实现了对</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">变量的保护，通过判断变量是否大于</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">0</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">以及自增减来实现信号量的申请和释放。也是因为这一点，所以信号量能够实现同步机制。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">另外，关于源码中的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">__down</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">和</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">__up</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数的实现内容，它们其实是维护申请信号量的进程的链表队列</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">(</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">增加、删除操作</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">)</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，以及进程调度方面的一些信息</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">(</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">超时机制</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">)</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，从而让进程实现休眠。由于其中的源码量较为庞大，涉及的内容也较多，故这里不再深入讨论，感兴趣的可以查阅相关资料。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">关于信号量的内容还有一点需要提及，我们知道信号量时进程级的，因此对于它的使用必然是当占用资源较长时间的时候。这点在使用信号量的使用需要重点考虑，反之，则容易影响程序的性能等。</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">OK</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，至此，关于信号量的内容即讨论到此。</span></p>
<h2 style=" padding: 0px; border: 0px; list-style: none; color: rgb(70, 70, 70); font-family: simsun; font-style: normal; font-variant: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: -1cm;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">七、</span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">读写信号量</span></h2>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">接下来笔者将讨论有关读写信号量的内容，这部分是较难的一部分，需分析较多的源码。同样，我们首先看下它主要能够做些什么：读写信号量与信号量的关系如同自旋锁与读写自旋锁的关系，它允许</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">N</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">个读操作同时访问共享资源，但最多只能有一个写操作。它的定义位置是在</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">arch\x86\include\asm\rwsem.h</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">以及</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">kernel\rwsem.c</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">中。关于它的结构体的定义，如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.1</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示。显然，它的结构体定义和信号量的结构体定义如出一辙。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s7.sinaimg.cn/orignal/6d7fa49bgbe2f647e0af6" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/99372D77-D74D-4C3A-A436-AB76A2E9B8D1.jpg" height="195" width="352"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图7.1 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写信号量的结构体实现</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">而后了解下它的具体使用方法，如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.2</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所展示的函数。同其它锁机制类似，它所提供的接口函数也是较为简单，包括这些函数能实现的功能都差不了多少。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s11.sinaimg.cn/orignal/6d7fa49bgf6dd9f7f8c5a" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/8C0CFFF8-CCF7-42D9-A6C6-19EA4DD81F3B.jpg" height="305" width="490"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图7.2 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写信号量的接口函数</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">在了解读写信号量的定义和使用后，接下来读者将讨论的具体源码实现。它的具体实现是采用汇编实现，比较绕，需配合源码来一一说明，源码次序依次如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.3</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">至图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.8</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示。为便于分析，下面源码只给出最为关键的内容。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">对于图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.3</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所展示的内容主要是读写信号量中需要使用的一些宏定义，具体为何取这个值笔者就不大了解了，后续研究深入了可能会有所体会。</span><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s5.sinaimg.cn/orignal/6d7fa49bgbe2f67100e94" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/62A96CE1-A0F1-485B-819C-86DD8F864B7F.jpg" height="193" width="672"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图7.3 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写自旋锁的内核源码</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s5.sinaimg.cn/orignal/6d7fa49bgbe2f68e94634" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/21FD2E4A-4F9E-4087-95D3-5C8025D46B5A.jpg" height="196" width="490"/></a><br/>
<span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图7.4 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写自旋锁的内核源码</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s7.sinaimg.cn/orignal/6d7fa49bgbe2f69fcb6c6" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/EC3D1C51-4D80-41FB-836B-56176EF6CA93.jpg" height="212" width="490"/></a></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;"><span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';"> </span>图7.5 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写自旋锁的内核源码</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.4</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">和同</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.5</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示源码主要体现了读锁和写锁的实现内容。实际上还是利用</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">test</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">指令检测</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">count</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">变量的值来实现。申请成功的内容好理解，其中的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">xadd</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">指令表示将原操作数和目的操作数值相交换，而后相加保存入目的操作数。一旦读写信号量申请失败，则需要跳转到如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.6</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.7</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示的源码中。其中图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.6</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">，图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.7</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">中所示的源码没多少内容，最后还是跳转到</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">rwsem_down_read_failed</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">和</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">rwsem_down_write_failed</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数中，通过汇编源码保存改变相应存储变量的寄存器，从而再次返回到</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">C</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">代码中，如图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.8</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示的源码中。由于笔者能力有限，对于图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">7.8</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">所示的源码内容中调用的</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">rwsem_down_write_failed</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">函数被没有研究透，故这里并未进一步深入研究。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">至此，关于读写信号量的内容讨论基本结束，确实由于笔者能力有限，关于读写信号量的内容以及本博文的系列内容，读者可进一步深入研究，并欢迎讨论。共同进步。</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; text-indent: 24pt;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s2.sinaimg.cn/orignal/6d7fa49bg796b2458cde1" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/BE4F8A52-24AE-4A98-A37C-F70978838136.jpg" height="256" width="665"/></a><br/></p>
<p align="center" style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center;"><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">      图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">7.6 </span> <span style="word-wrap: normal; word-break: normal; font-family: 宋体;">读写自旋锁的内核源码</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">                                        </span><span style="word-wrap: normal; word-break: normal; font-family: 宋体;">图</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-family: 'Times new roman', serif;">7.7 </span> <span style="word-wrap: normal; word-break: normal; font-family: 宋体;">读写自旋锁的内核源码</span></p>
<p align="center" style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center;"><a href="http://photo.blog.sina.com.cn/showpic.html#blogid=6d7fa49b01014q8y&amp;url=http://s2.sinaimg.cn/orignal/6d7fa49bgbe2f6d23dc21" target="_blank" style="text-decoration: none; color: rgb(144, 80, 50);"><img src="%E5%A4%A7%E8%AF%9DLinux%E5%86%85%E6%A0%B8%E4%B8%AD%E9%94%81%E6%9C%BA%E5%88%B6%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E3%80%81%E8%AF%BB%E5%86%99%E4%BF%A1%E5%8F%B7%E9%87%8F.resources/CE94114B-1F12-4522-835D-F63C3023A44C.jpg" height="267" width="690"/></a></p>
<p align="center" style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center;"><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 'Times new roman', serif;">图7.8 <span style="word-wrap: normal; word-break: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times new roman';">    </span></span> <span style="word-wrap: normal; word-break: normal; text-indent: -21pt; font-family: 宋体;">读写自旋锁的内核源码</span></p>
<p style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;"><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">出于文章篇幅的限制，本篇博文</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">到此结束，后续将会给出《大话</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;">Linux</span><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">内核中锁机制之完成量、互斥量》，感兴趣的读者可继续阅读后一篇博文。由于笔者水平所限，博文中难免有出错之处，欢迎读者指出，大家相互讨论，共同进步。</span></p>
</div>
<div><br/></div>
<div>
<div style="padding: 0px; border: 0px; list-style: none; word-wrap: normal; word-break: normal; color: rgb(70, 70, 70); font-family: simsun; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-indent: 24pt;">
<div><span style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 宋体;">转载请注明出处：</span><span lang="EN-US" xml:lang="EN-US" style="word-wrap: normal; word-break: normal; font-size: 12pt; font-family: 'Times new roman', serif;"><a href="http://blog.sina.com.cn/huangjiadong19880706">http://blog.sina.com.cn/huangjiadong19880706</a></span></div>
</div>
</div>
</body></html>